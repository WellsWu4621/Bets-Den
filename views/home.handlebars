<br>
<div class="container">
  <div class="row row-cols-1 row-cols-md-2 g-4" id="content">
    {{!-- stuff goes here --}}

  </div>
</div>
<div class="modal fade" id="betModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" id="modalContent">

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
<script>
  const renderbets = () => {
    axios.get('/api/bets', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
      .then(({ data: bets }) => {
        document.getElementById('content').innerHTML = ''
        bets.forEach(bet => {
          let post = document.createElement('div')
          post.innerHTML = `
              <div class="col">
                <div class="card border-dark mb-3" style="width: 18rem;">
                  <div class="card-body">
                    <h5 class="card-title">${bet.name}</h5>
                    <h7>Current Betting Values</h7>
                    <p class="card-text">For: ${bet.for_value} Tokens; Against: ${bet.against_value} Tokens</p>
                    <p class="card-text">${bet.description}</p>
                  </div>
                  <div class="card-footer">
                    <a data-bs-toggle="modal" data-betid="${bet.id}" href="#betModal" class="modalbtn btn btn-primary">View this Bet</a>
                  </div>
                </div>
              </div>
            `
          document.getElementById('content').append(post)
        })
      })
      .catch((err) => {
        console.log(err)
        window.location = '/login'
      })
  }
  const renderModal = (betid) => {
    document.getElementById('modalContent').innerHTML = ""
    axios.get(`/api/bets/${betid}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
      .then(({ data: bet }) => {
        axios.get(`/api/users/${bet.creator_id}`)
          .then((creator) => {
            let post = document.createElement('div')
            post.innerHTML = `
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">${bet.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <h6>Current Betting Values</h6>
                    <p class="card-text">For: ${bet.for_value} Tokens; Against: ${bet.against_value} Tokens</p>
                    <p>${bet.description}</p>
                    <br>
                    <h6>Witnesses:</h6>
                    <p id="witnesslist"></p>
                    <br>
                    <h6>Participants:</h6>
                    <p id="counter"></p>
                    <p id="participantlist"></p>
                    <br>
                    <h7 class="card-subtitle mb-2 text-muted">Created by ${creator.data.username} at ${bet.createdAt}</h7>
                  </div>
                  <hr>
                  <div class="text-center" id="modalfooter">
                    <form>
                      <input class="form-control form-control-sm" type="text" id='aligntrue' placeholder="Whole number of Tokens" aria-label=".form-control-sm example">
                      <button type="button" class="joinbtn btn btn-secondary" data-betid="${bet.id}" data-align="true" data-value="${bet.for_value}">Bet With</button>
                    </form>
                    <form>
                      <input class="form-control form-control-sm" type="text" id='alignfalse' placeholder="Whole number of Tokens" aria-label=".form-control-sm example">
                      <button type="button" class="joinbtn btn btn-secondary" data-betid="${bet.id}" data-align="false" data-value="${bet.against_value}">Bet Against</button>
                    </form>
                  </div>
                </div>
                `
            document.getElementById('modalContent').append(post)
            renderWitness(bet)
            renderParticipant(bet)
            axios.get('/api/user', {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              }
            })
              .then(({ data: userid }) => {
                let witnessid = isWitness(bet, userid)
                let participantid = isParticipant(bet, userid)

                if (witnessid > 0) {
                  let footer = document.createElement('div')
                  document.getElementById('modalfooter').innerHTML = ''
                  footer.innerHTML = '<p>You appear to have already signed onto this bet as a Witness. If you would like to update the result of the bet, please go to your<a href="/dashboard">Dashboard</a></p><button class="hidden joinbtn"></button>'
                  document.getElementById('modalfooter').append(footer)
                }
                else if (participantid > 0) {
                  let footer = document.createElement('div')
                  document.getElementById('modalfooter').innerHTML = ''
                  axios.get(`/api/participants/${participantid}`, {
                    headers: {
                      'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                  })
                    .then(({data: participant}) => {
                      if (participant.alignCreator) {
                        footer.innerHTML = `<p>You are currently betting FOR: ${participant.betamount} Tokens.</p><button class="hidden joinbtn"></button>`
                        document.getElementById('modalfooter').append(footer)
                      }
                      else {
                        footer.innerHTML = `<p>You are currently betting AGAINST: ${participant.betamount} Tokens.</p><button class="hidden joinbtn"></button>`
                        document.getElementById('modalfooter').append(footer)
                      }
                    })
                }
                else if (bet.creator_id === userid) {
                  let footer = document.createElement('div')
                  document.getElementById('modalfooter').innerHTML = ''
                  footer.innerHTML = `<p>You are the creator of the bet and a default participant listed as FOR: ${bet.creator_value} Tokens.</p><button class="hidden joinbtn"></button>`
                  document.getElementById('modalfooter').append(footer)
                }
              })
          })
      })
      .catch(err => console.log(err))
  }
  const renderWitness = (bet) => {
    console.log(bet.witnesses.length)
    if (bet.witnesses.length > 0) {
      for (let w = 0; w < bet.witnesses.length; w++) {
        axios.get(`/api/user/${bet.witnesses[w].user_id}`)
          .then(witness => {
            document.getElementById('witnesslist').innerText += `${witness.data.name}`
            if (w + 1 !== bet.witnesses.length) {
              document.getElementById('witnesslist').innerText += ', '
            }
          })
          .catch(err => console.log(err))
      }
    }
    else {
      document.getElementById('witnesslist').innerText = 'This bet does not have a witness yet.'
    }
  }
  const renderParticipant = (bet) => {
    let creator = 1
    let against = 0
    if (bet.participants.length > 0) {
      for (let p = 0; p < bet.participants.length; p++) {
        axios.get(`/api/users/${bet.participants[p].user_id}`)
          .then(participant => {
            if (!bet.participants[p].alignCreator) against++
            else creator++
            document.getElementById('participantlist').innerText += `${participant.data.username}`
            if (p + 1 !== bet.participants.length) {
              document.getElementById('participantlist').innerText += ', '
            }
            else {
              document.getElementById('counter').innerText = `For: ${creator}, Against: ${against}`
            }
          })
          .catch(err => console.log(err))
      }

    }
    else {
      document.getElementById('counter').innerText = `For: ${creator}, Against: ${against}`
      document.getElementById('participantlist').innerText = 'This bet does not have any participants besides the creator yet.'
    }
  }
  const isParticipant = (bet, id) => {
    let occupied_id = 0
    for (let p = 0; p < bet.participants.length; p++) {
      if (bet.participants[p].user_id === id) {
        occupied_id = bet.participants[p].id
      }
    }
    return occupied_id
  }
  const isWitness = (bet, id) => {
    let occupied_id = 0
    for (let w = 0; w < bet.witnesses.length; w++) {
      if (bet.witnesses[w].user_id === id) {
        occupied_id = bet.witnesses[w].id
      }
    }
    return occupied_id
  }

  // function call
  renderbets()

  document.addEventListener('click', event => {
    if (event.target.classList.contains('modalbtn')) {
      let betid = event.target.getAttribute('data-betid')
      renderModal(betid)
    }
  })

  document.addEventListener('click', event => {
    if (event.target.classList.contains('joinbtn')) {
      let betid = event.target.getAttribute('data-betid')
      let alignment = false
      let searchside = ""
      let amount = 0
      let currentamt = parseInt(event.target.getAttribute('data-value'))
      if (event.target.getAttribute('data-align') === 'true') {
        alignment = true
        searchside = "for"
        amount = parseInt(document.getElementById('aligntrue').value)
        currentamt += amount
      }
      else {
        alignment = false
        searchside = "against"
        amount = parseInt(document.getElementById('alignfalse').value)
        currentamt += amount
      }
      axios.post('/api/participants', {
        alignCreator: alignment,
        betamount: amount,
        bet_id: betid
      }, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
        .then(() => {
          axios.put(`/api/bets/${betid}/${searchside}amount`, {
            value: currentamt
          }, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          })
            .then(() => {
              renderModal(betid)
            })
        })
        .catch(err => console.log(err))
    }
  })
</script>